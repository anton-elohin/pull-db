#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ yq –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
if ! command -v yq &> /dev/null; then
    echo "‚ùå yq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—ã—Ç–∞—é—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å..."
    ddev install-system-dep yq
fi

# –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
CONFIG_FILE=".ddev/config.remote.yaml"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ $CONFIG_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -z "$1" ]; then
    # –ï—Å–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑ —Å–ø–∏—Å–∫–∞
    ENVIRONMENT=$(yq e '.environments | keys | .[0]' "$CONFIG_FILE")

    if [ -z "$ENVIRONMENT" ]; then
        echo "‚ùå –í –∫–æ–Ω—Ñ–∏–≥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è!"
        exit 1
    fi

    echo "‚ÑπÔ∏è –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤–æ–µ: $ENVIRONMENT"
else
    ENVIRONMENT="$1"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ
if ! yq e ".environments.$ENVIRONMENT" "$CONFIG_FILE" | grep -vq 'null'; then
    AVAILABLE_ENVS=$(yq e '.environments | keys | join(", ")' "$CONFIG_FILE")
    echo "‚ùå –û–∫—Ä—É–∂–µ–Ω–∏–µ '$ENVIRONMENT' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ"
    echo "   –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: $AVAILABLE_ENVS"
    exit 1
fi

# –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
HOST=$(yq e ".environments.$ENVIRONMENT.host" "$CONFIG_FILE")
SSH_PORT=$(yq e ".environments.$ENVIRONMENT.ssh_port" "$CONFIG_FILE")
USERNAME=$(yq e ".environments.$ENVIRONMENT.username" "$CONFIG_FILE")
SSH_PASSWORD=$(yq e ".environments.$ENVIRONMENT.ssh_password" "$CONFIG_FILE")
PROJECT_ROOT=$(yq e ".environments.$ENVIRONMENT.project_root" "$CONFIG_FILE")

DB_HOST=$(yq e ".environments.$ENVIRONMENT.database.host // \"localhost\"" "$CONFIG_FILE")
DB_PORT=$(yq e ".environments.$ENVIRONMENT.database.port // 3306" "$CONFIG_FILE")
DB_NAME=$(yq e ".environments.$ENVIRONMENT.database.name" "$CONFIG_FILE")
DB_USER=$(yq e ".environments.$ENVIRONMENT.database.login" "$CONFIG_FILE")
DB_PASS=$(yq e ".environments.$ENVIRONMENT.database.password" "$CONFIG_FILE")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è sshpass –¢–û–õ–¨–ö–û –ï–°–õ–ò –£–ö–ê–ó–ê–ù –ü–ê–†–û–õ–¨
if [[ -n "$SSH_PASSWORD" && "$SSH_PASSWORD" != "null" ]]; then
    if [[ "$OS" == "MINGW"* || "$OS" == "MSYS"* || "$OS" == "CYGWIN"* ]]; then
        echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SSH-–ø–∞—Ä–æ–ª—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ Windows!"
        exit 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ sshpass —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
    if ! command -v sshpass &> /dev/null; then
        echo "‚ùå sshpass –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—ã—Ç–∞—é—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å..."
        
        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ sshpass
        install_sshpass() {
            ddev install-system-dep sshpass
        }
        
        install_sshpass
        if ! command -v sshpass &> /dev/null; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å sshpass!"
            exit 1
        fi
    fi
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü
IGNORE_TABLES=($(yq e ".environments.$ENVIRONMENT.ignore_tables | .[]" "$CONFIG_FILE"))
IGNORE_TABLES_FORCE=($(yq e ".environments.$ENVIRONMENT.ignore_tables_force | .[]" "$CONFIG_FILE"))

# –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å --ignore-table
ignore_flags=""
for table in "${IGNORE_TABLES[@]}" "${IGNORE_TABLES_FORCE[@]}"; do
    ignore_flags+="--ignore-table=${DB_NAME}.${table} "
done

# –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É mysqldump –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ë–ï–ó –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü)
DUMP_CMD="mysqldump \
        --no-tablespaces \
        -h $DB_HOST -P $DB_PORT -u $DB_USER -p'$DB_PASS' \
        --single-transaction --quick $ignore_flags $DB_NAME"

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–∞–º–ø–∞
MAIN_DUMP=$(mktemp).sql

# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–∞–º–ø–∞
echo "üîÑ –ó–∞–ø—É—Å–∫ –¥–∞–º–ø–∞ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è $ENVIRONMENT..."
echo "üîó SSH: $USERNAME@$HOST:$SSH_PORT"
echo "üîë –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å SSH: $( [[ -n "$SSH_PASSWORD" && "$SSH_PASSWORD" != "null" ]] && echo "–¥–∞" || echo "–Ω–µ—Ç" )"
echo "üìÅ –ü—É—Ç—å: $PROJECT_ROOT"
echo "‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã DB: $DB_USER@$DB_HOST/$DB_NAME"
echo "üö´ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã: ${IGNORE_TABLES[*]}"
echo "üö´ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ (–±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã): ${IGNORE_TABLES_FORCE[*]}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SSH-–∫–æ–º–∞–Ω–¥—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–∞—Ä–æ–ª—è
run_ssh() {
    local cmd="$1"
    if [[ -n "$SSH_PASSWORD" && "$SSH_PASSWORD" != "null" ]]; then
        SSHPASS="$SSH_PASSWORD" sshpass -e ssh -p "$SSH_PORT" "$USERNAME@$HOST" "$cmd"
    else
        ssh -p "$SSH_PORT" "$USERNAME@$HOST" "$cmd"
    fi
}

# –í—ã–ø–æ–ª–Ω—è–µ–º –¥–∞–º–ø —á–µ—Ä–µ–∑ SSH
run_ssh "cd $PROJECT_ROOT && $DUMP_CMD" > "$MAIN_DUMP"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
if [ $? -ne 0 ] || [ ! -s "$MAIN_DUMP" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–∞–º–ø–∞!"
    rm -f "$MAIN_DUMP"
    exit 1
fi

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –±–∞–∑—É
echo "üì• –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –±–∞–∑—É –≤ DDEV (—Ä–∞–∑–º–µ—Ä: $(du -h "$MAIN_DUMP" | cut -f1))..."
ddev import-db --src="$MAIN_DUMP"
rm -f "$MAIN_DUMP"

# –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü
if [ ${#IGNORE_TABLES[@]} -ne 0 ]; then
    echo "üõ†Ô∏è –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü..."

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è SQL-—Å—Ç—Ä—É–∫—Ç—É—Ä
    STRUCTURE_FILE=$(mktemp).sql

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ SQL
    {
    echo "SET SESSION sql_mode = 'NO_AUTO_VALUE_ON_ZERO';"
    echo "SET FOREIGN_KEY_CHECKS=0;"
    } > "$STRUCTURE_FILE"

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É—Å—Ç—ã—Ö —Ç–∞–±–ª–∏—Ü
    for table in "${IGNORE_TABLES[@]}"; do
        echo "üîß –¢–∞–±–ª–∏—Ü–∞: $table"

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        CREATE_CMD="mysqldump --no-tablespaces -h $DB_HOST -P $DB_PORT -u $DB_USER -p'$DB_PASS' \
                    --no-data --skip-lock-tables --compact --skip-add-drop-table $DB_NAME $table"

        if [[ "$OS" == "MINGW"* || "$OS" == "MSYS"* || "$OS" == "CYGWIN"* ]]; then
            ssh.exe -p "$SSH_PORT" "$USERNAME@$HOST" "cd $PROJECT_ROOT && $CREATE_CMD" | \
            sed -e 's/AUTO_INCREMENT=[0-9]*\b//g' \
                -e 's/^\/\*![0-9]\{5\}.*\/;$//g' \
                -e 's/CREATE TABLE/CREATE TABLE IF NOT EXISTS/' \
            >> "$STRUCTURE_FILE"
        else
            run_ssh "cd $PROJECT_ROOT && $CREATE_CMD" | \
            sed -e 's/AUTO_INCREMENT=[0-9]*\b//g' \
                -e 's/^\/\*![0-9]\{5\}.*\/;$//g' \
                -e 's/CREATE TABLE/CREATE TABLE IF NOT EXISTS/' \
            >> "$STRUCTURE_FILE"
        fi

        echo ";" >> "$STRUCTURE_FILE"
        echo "TRUNCATE TABLE \`$table\`;" >> "$STRUCTURE_FILE"
        echo "" >> "$STRUCTURE_FILE"
    done

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
    echo "SET FOREIGN_KEY_CHECKS=1;" >> "$STRUCTURE_FILE"

    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
    if [ -s "$STRUCTURE_FILE" ]; then
        echo "üì§ –ò–º–ø–æ—Ä—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä —Ç–∞–±–ª–∏—Ü (—Ä–∞–∑–º–µ—Ä: $(du -h "$STRUCTURE_FILE" | cut -f1))..."
        ddev import-db --no-drop --src="$STRUCTURE_FILE"
        rm -f "$STRUCTURE_FILE"
    else
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü"
        rm -f "$STRUCTURE_FILE"
    fi
fi

echo "‚úÖ –ë–∞–∑–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è '$ENVIRONMENT' —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞! –ü—É—Å—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã."
